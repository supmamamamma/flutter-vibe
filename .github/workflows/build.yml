name: Build Flutter (by Tag or Manual)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version like 1.2.3 or v1.2.3 or 1.2.3+45"
        required: true
        type: string

env:
  FLUTTER_VERSION: "stable"
  PROJECT_DIR: "."

jobs:
  prepare:
    name: Prepare version
    runs-on: ubuntu-latest
    outputs:
      raw_version: ${{ steps.ver.outputs.raw_version }}
      build_name: ${{ steps.ver.outputs.build_name }}
      build_number: ${{ steps.ver.outputs.build_number }}
    steps:
      - id: ver
        shell: bash
        run: |
          set -euo pipefail

          # 1) get raw version from tag or manual input
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            RAW="${GITHUB_REF_NAME}"         # e.g. v1.2.3 or v1.2.3+45
          else
            RAW="${{ inputs.version }}"      # e.g. 1.2.3 or v1.2.3+45
          fi

          # 2) strip leading 'v'
          RAW="${RAW#v}"                     # 1.2.3 or 1.2.3+45

          # 3) split build name / number
          # If tag has +number, use it as build-number; else fallback to run_number.
          if [[ "$RAW" == *"+"* ]]; then
            BUILD_NAME="${RAW%%+*}"
            BUILD_NUMBER="${RAW##*+}"
          else
            BUILD_NAME="$RAW"
            BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          fi

          # sanity check: build number must be digits
          if ! [[ "$BUILD_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Invalid build number: $BUILD_NUMBER (expect digits). Use tag like v1.2.3+45"
            exit 1
          fi

          echo "raw_version=$RAW" >> "$GITHUB_OUTPUT"
          echo "build_name=$BUILD_NAME" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"

          echo "Resolved:"
          echo "  RAW=$RAW"
          echo "  BUILD_NAME=$BUILD_NAME"
          echo "  BUILD_NUMBER=$BUILD_NUMBER"

  web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: prepare
    defaults:
      run:
        working-directory: ${{ env.PROJECT_DIR }}
    env:
      BUILD_NAME: ${{ needs.prepare.outputs.build_name }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
      RAW_VERSION: ${{ needs.prepare.outputs.raw_version }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build web --release --build-name="$BUILD_NAME" --build-number="$BUILD_NUMBER"
      - uses: actions/upload-artifact@v4
        with:
          name: web-${{ env.RAW_VERSION }}
          path: ${{ env.PROJECT_DIR }}/build/web

  android:
    name: Build Android (APK + AAB)
    runs-on: ubuntu-latest
    needs: prepare
    defaults:
      run:
        working-directory: ${{ env.PROJECT_DIR }}
    env:
      BUILD_NAME: ${{ needs.prepare.outputs.build_name }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
      RAW_VERSION: ${{ needs.prepare.outputs.raw_version }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build apk --release --build-name="$BUILD_NAME" --build-number="$BUILD_NUMBER"
      - run: flutter build appbundle --release --build-name="$BUILD_NAME" --build-number="$BUILD_NUMBER"
      - uses: actions/upload-artifact@v4
        with:
          name: android-${{ env.RAW_VERSION }}
          path: |
            ${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk/*.apk
            ${{ env.PROJECT_DIR }}/build/app/outputs/bundle/release/*.aab

  ios:
    name: Build iOS (no codesign)
    runs-on: macos-14
    needs: prepare
    defaults:
      run:
        working-directory: ${{ env.PROJECT_DIR }}
    env:
      BUILD_NAME: ${{ needs.prepare.outputs.build_name }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
      RAW_VERSION: ${{ needs.prepare.outputs.raw_version }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build ios --release --no-codesign --build-name="$BUILD_NAME" --build-number="$BUILD_NUMBER"
      - name: Package .app
        run: |
          set -e
          APP_PATH="build/ios/iphoneos/Runner.app"
          test -d "$APP_PATH"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "ios-Runner-${RAW_VERSION}.app.zip"
      - uses: actions/upload-artifact@v4
        with:
          name: ios-${{ env.RAW_VERSION }}
          path: ${{ env.PROJECT_DIR }}/ios-Runner-${{ env.RAW_VERSION }}.app.zip

  windows:
    name: Build Windows
    runs-on: windows-latest
    needs: prepare
    defaults:
      run:
        working-directory: ${{ env.PROJECT_DIR }}
    env:
      BUILD_NAME: ${{ needs.prepare.outputs.build_name }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
      RAW_VERSION: ${{ needs.prepare.outputs.raw_version }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build windows --release --build-name="${{ env.BUILD_NAME }}" --build-number="${{ env.BUILD_NUMBER }}"
      - name: Package Windows output
        shell: pwsh
        run: |
          $out1 = "build\windows\x64\runner\Release"
          $out2 = "build\windows\runner\Release"
          if (Test-Path $out1) { $out = $out1 }
          elseif (Test-Path $out2) { $out = $out2 }
          else { throw "Windows build output not found." }

          $zip = "windows-release-${env:RAW_VERSION}.zip"
          Compress-Archive -Path "$out\*" -DestinationPath $zip -Force
      - uses: actions/upload-artifact@v4
        with:
          name: windows-${{ env.RAW_VERSION }}
          path: ${{ env.PROJECT_DIR }}/windows-release-${{ env.RAW_VERSION }}.zip
